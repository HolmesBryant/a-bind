class t extends HTMLElement{_edit=!1;_highlight=!1;_inline=!1;_indent=4;_lineNumbers=!1;_palette="default";#t;#e;#i;#n=Date.now();#s;highlighter;defaults={};static observedAttributes=["highlight","inline","indent","line-numbers","palette"];static template='\n    <style>\n      :host {\n        --indent: 1;\n        --line-number-color: gray;\n        --wrap: pre;\n        display: block;\n        max-width: 100%;\n        vertical-align: top;\n      }\n\n      :host([inline]) {\n        display: inline-block;\n        padding: 0;\n      }\n\n      section {\n        display: inline-grid;\n        gap: .5rem;\n        grid-template-columns: max-content 1fr;\n        width: 100%;\n      }\n\n      #content {\n        font-family: "Courier New", monospace;\n        tab-size: var(--indent);\n        white-space: var(--wrap);\n        overflow: auto;\n      }\n\n      #line-numbers {\n        color: var(--line-number-color);\n        font-family: monospace;\n        white-space: pre-line;\n      }\n    </style>\n\n    <section part="section">\n      <div id="line-numbers" part="line-numbers"></div>\n      <div id="content" part="content"><slot></slot></div>\n    </section>\n  ';constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML=t.template}attributeChangedCallback(t,e,i){this[t=t.replace(/-./g,(t=>t.toUpperCase()[1]))]=i}connectedCallback(){const t=this.shadowRoot.querySelector("slot");this.#e=this.shadowRoot.querySelector("#content"),this.#s=this.shadowRoot.querySelector("#line-numbers"),this.#t=new AbortController,this.textContent=this.resetSpaces(this.getContent()),this.highlight&&this.highlightCode(),this.lineNumbers&&this.addLineNumbers(),this.setDefaults(),t.addEventListener("slotchange",(()=>{this.update(10)}),{signal:this.#t.signal})}disconnectedCallback(){this.#t&&(this.#t.abort(),this.#t=null),this.#i&&(this.#i.abort(),this.#i=null),this.destroyHighlights(),this.highlighter=null,this._palette="default",this.#e=null,this.#s=null}addLineNumbers(){if(!this.#s)return;this.#s.children.length>0&&this.removeLineNumbers();const t=this.textContent.split(/\r?\n/).length,e=document.createElement("div");for(let i=1;i<=t;i++){const t=e.cloneNode();t.id="line-"+i,t.textContent=i,this.#s.append(t)}}convertHTML(t){const e=document.createElement("textarea");return e.innerHTML=t,e.value}disableEdit(){this.#e.toggleAttribute("contentEditable",!1)}destroyHighlights(){if(this.highlighter)try{return this.highlighter.removeAll()}catch(t){console.error(t)}}enableEdit(){this.#e.toggleAttribute("contentEditable",!0)}getContent(){return this.children[0]&&"textarea"===this.children[0].localName?this.textContent.replace("\\/","/"):this.convertHTML(this.innerHTML)}async highlightCode(t=this.highlight){if(!1!==t){this.highlighter=this.highlighter||new e(this);try{return await this.highlighter.highlight(t,this.childNodes[0])}catch(t){throw t}}}removeLineNumbers(){this.#s&&(this.#s.innerHTML="")}reset(){for(const t of ABind.observedAttributes)this[t]=this.defaults[t]}resetSpaces(t){this.needsUpdate=!1,t=t.replace(/^ +/gm,(t=>"\t".repeat(t.length))).trim();const e=t.split("\n"),i=e.at(-1).match(/^\s*/)[0].length,n=new RegExp(`^\\s{${i}}`,"g");return e.map((t=>t.replace(n,""))).join("\n")}setDefaults(){if(!(Object.keys(this.defaults).length>0))for(const e of t.observedAttributes)this.defaults[e]=this[e]}update(t=10){const e=Date.now();e-this.#n<t||(this.#n=e,this.textContent=this.resetSpaces(this.getContent()),this.highlighter&&this.destroyHighlights(),this.lineNumbers=this.lineNumbers,setTimeout((()=>{this.highlight&&this.highlightCode()})))}get inline(){return this._inline}set inline(t){!0===(t=""!==t&&"false"!==t&&!1!==t)?(this.style.setProperty("--wrap","nowrap"),this.lineNumbers=!1):(this.style.removeProperty("--wrap"),this.hasAttribute("line-numbers")&&(this.lineNumbers=this.getAttribute("line-numbers"))),this._inline=t,window.abind&&abind.update(this,"inline",t)}get indent(){return this._indent}set indent(t){t||(t=this.defaults.indent),this.style.setProperty("--indent",t),this._indent=t,window.abind&&abind.update(this,"indent",t)}get highlight(){return this._highlight}set highlight(t){switch(t){case"false":case!1:t=!1;break;case"":case null:t="html"}this._highlight=t,this.#e&&this.update(),window.abind&&abind.update(this,"inline",t)}get edit(){return this._edit}set edit(t){switch(t){case"false":case!1:this._edit=!1,this.#e&&this.disableEdit();break;default:this._edit=!0,this.#e?this.enableEdit():customElements.whenDefined(this.localName).then((t=>{this.enableEdit()}))}window.abind&&abind.update(this,"inline",this._edit)}get lineNumbers(){return this._lineNumbers}set lineNumbers(t){t=""!==t&&"false"!==t&&!1!==t,this._lineNumbers=t,!0===t?this.addLineNumbers():this.removeLineNumbers(),window.abind&&abind.update(this,"lineNumbers",this._lineNumbers)}get palette(){return this._palette}set palette(t){this.highlighter?(this.highlighter.palette="default"===t?"":t,window.abind&&abind.update(this,"inline",t)):console.error("highlighter has not been initialized")}}class e{_palette;container;highlighter=null;suffix="_"+Math.random().toString(36).substring(2,15);defaultColors=new Map([["argument","hsl(32, 93%, 66%)"],["comment","hsl(221, 12%, 69%)"],["function","hsl(210, 50%, 60%)"],["keyword","deeppink"],["number","hsl(32, 93%, 50%)"],["operator","red"],["property","orchid"],["string","hsl(114, 31%, 68%)"],["variable","darkkhaki"],["tag","indianred"]]);defaultSyntaxDef={argument:/(?<=\()[^)]+/g,function:/[\w-]+\s*\(|\)/g,operator:/[>+~*,*\/=]|(?<!\w[-])/g,property:/(?<!}[\r\n\s]+)\b([\w\d-]+:(?!:))/g,number:/(?<!\w)[#+-.]?\d+[%\b\.\w]*/g,tag:/<\/?[\w-]+|(?<=[\w"])>/g,string:/["'`][^"'`]*["'`]/g,variable:/--[\w\d]+-?[\w\d]*/g,comment:/(<!--|\/\*)([\s\S]*?)(-->|\*\/)/g,keyword:/@[\w]+\b/g};constructor(t,e){return this.container=t,this.palette=e,this}async highlight(t="html",e){if(void 0===window.Highlight)throw new Error("Browser does not support CSS Custom Highlight API");e=e||this.container.childNodes[0]||document.createTextNode("");const i=`highlights${this.suffix}`;document.head.querySelector(`#${i}`)||document.head.append(this.getStyle());try{const i=await this.getSyntax(t);return this.highlightCode(i,e),!0}catch(t){throw console.error("Error loading Highlight Syntax: ",t),t}}async getSyntax(t){if(!t||"html"===t)return this.defaultSyntaxDef;if("string"==typeof t){let e=t;/^(http|\.|\/)/.test(t)||(e=`./syntax.${t}.js`);try{t=await import(e)}catch(t){throw t}}return t.default}highlightCode(t={},e){if(e.nodeType!==Node.TEXT_NODE)throw new Error(`Second argument must be a TEXT_NODE (3). Given nodeType is (${e.nodeType})`);let i;const n=e.textContent;for(const s of Object.keys(t)){const h=t[s];if(h){if(Array.isArray(h)){const t=[...new Set(h)].join("|"),s=new RegExp(`\\b(${t})\\b`,"g");i=this.setRanges(s,n,e)}else if(h instanceof Function)i=new Set(h(n,e));else{if(!(h instanceof RegExp))throw console.error(`Invalid syntax definition for ${s}: `,`"${h}"`),new Error(`Invalid syntax definition for ${s}`);i=this.setRanges(h,n,e)}this.setHighlight(i,s)}}return!0}setRanges(t,e,i){const n=new Set,s=e.matchAll(t);for(const t of s){const e=t.index,s=e+t[0].length,h=new Range;h.setStart(i,e),h.setEnd(i,s),n.add(h)}return n}getHighlights(){const t=new Map;return CSS.highlights.forEach(((e,i)=>{i.endsWith(this.suffix)&&t.set(i,e)})),t}setHighlight(t,e="test"){e+=this.suffix,this.highlighter=new Highlight(...t);try{return CSS.highlights.set(e,this.highlighter),!0}catch(t){throw t}}getStyle(){const t=document.createElement("style");let e="";return t.id=`highlights${this.suffix}`,this.palette.forEach(((t,i)=>{e+=`::highlight(${i}${this.suffix}) { color: ${t}}\n`})),t.textContent=e,t}remove(t){CSS.highlights.delete(t+this.suffix)}removeAll(){return CSS.highlights.forEach(((t,e)=>{e.endsWith(this.suffix)&&CSS.highlights.delete(e)})),this.suffix}clearRegistry(){CSS.highlights.clear()}logRegistry(){CSS.highlights.forEach(((t,e)=>{console.log(e,t)}))}get palette(){return this._palette||this.defaultColors}set palette(t){let e;const i=document.head.querySelector(`_highlights${this.suffix}`);if(t&&""!==t&&void 0!==t)if(Array.isArray(t))e=new Map(t);else if(t instanceof Map)e=t;else try{t=JSON.parse(t),e=new Map(t)}catch(t){console.error(t)}else this._palette=null;this._palette=e;const n=this.getStyle();i?document.head.replaceChild(n,i):document.head.append(n)}}document.addEventListener("DOMContentLoaded",(()=>{customElements.get("a-code")||customElements.define("a-code",t)}));export{t as ACode,e as Highlighter};
