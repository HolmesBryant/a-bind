class t{filePath;initialized=!1;lineNumbers=!0;modules={};onlyFailed=!1;#t;#e="console";pauseOnFail=!1;position="beforeend";startTime=Date.now();template;testNum=0;tests=new Set;totalTests=0;constructor(t=null){if(this.filePath=t,this.A=new e,null===t)return this.A._init(this)}convertTime(t){return{hours:Math.floor(t/36e5),minutes:Math.floor(t%36e5/6e4),seconds:Math.floor(t%36e5%6e4/1e3),milliseconds:t%1e3}}async fetchCode(t=null){if(t=t||this.filePath,this.#s())return this.#n(t);try{const e=await fetch(t);if(!e.ok)throw new Error(`Failed to fetch ${t}: ${e.status} ${e.statusText}`);return await e.text()}catch(e){throw new Error(`Failed to fetch ${t}`,{cause:e})}}#i(t,e){let s=1;const n=[...e.matchAll(/\n/g)].map((t=>t.index));for(const e of n){if(!(t>e))break;s++}return s}async getModules(t=null){let e;if(t=t??this.filePath,this.#s())e=await this.#o(t);else try{e=await import(t)}catch(e){throw new Error(`getModules failed to import modules from: ${t}`,{cause:e})}for(const t in e)this.modules[t]=e[t];return this.modules}getTests(t=null){const e=(t=t??this.fetchCode()).matchAll(/@test([\s\S]*?)\\{2}([^\n]*)\n/g);for(const s of e){const e=s[1].trim();let n=s[2].replace("\\","").trim();const i=this.lineNumbers?this.#i(s.index,t):null;this.tests.add([e,n,i]),e.startsWith("mock")&&e.startsWith("info")||this.totalTests++}return this.tests}#r(t,e,s){let n;try{"object"==typeof t&&t instanceof HTMLElement==!1?t=JSON.stringify(t):"string"==typeof t&&(t=t.replace(/'/g,""))}catch(e){throw n="getVerdict error with result value",this.printResult(n,"error",t,null,s),new Error(`${n} on line ${s}`,{cause:e})}try{"object"==typeof e&&t instanceof HTMLElement==!1&&(e=JSON.stringify(e))}catch(t){n="getVerdict error with expected value",this.printResult(n,"error",null,e,s),console.error(`${n} on line ${s}`,t)}return t===e?"pass":"fail"}async init(t){if(this.initialized)return;let e;t=t||this.filePath;try{if(!t)throw new Error("No file path provided");e=await this.fetchCode(t),this.getTests(e);const s=await this.getModules();for(const t in s)this.A[t]=s[t]}catch(t){throw this.printResult(`ATestRunner: ${t.message} | ${t.cause}`,"error",null,null,null),new Error("Could not initialize:",{cause:t})}return this.initialized=!0,this}#s(){return"undefined"!=typeof process&&process.versions&&process.versions.node}async#o(t){const e=await import("node:path");await import("node:url");const s=e.resolve(t),n=new URL(`file:///${s}`);try{return await import(n)}catch(t){throw new Error(`NodeGetModules failed to import the module at ${n}`,{cause:t})}}async#n(t){t=t||this.filePath;try{if(this.#s()){const e=await import("node:fs/promises");return await e.readFile(t,"utf-8")}throw new Error("Node.js file reading is not supported in this environment")}catch(e){throw new Error(`NodeReadfile to read ${t}: ${e.message}`)}}#l(t,e,s,n,i,o){if(o=o??"",!this.output)throw new Error("No DOM container was found.");"object"==typeof n&&null!=n&&(n=JSON.stringify(n)),"object"==typeof s&&null!=n&&(s=JSON.stringify(s));let r=`\n      <div class="${e}">\n      <span class="test-num">${o}</span>\n      <span class="verdict"><b>${e}</b></span>\n    `;if(null!==n&&(r+=`<span class="expected"><b>Expected: </b>${n}</span>`),null!==s&&(r+="info"===e?`<span class="result">${s}</span>`:`<span class="result"><b>Result: </b>${s}</span>`),null!==i&&(r+=`<span class="line"><b>Line: </b>${i}</span>`),r+=`\n      <pre class="test">${t}</pre>\n      </div>\n    `,this.template){let t,e=this.template.template,s=this.template.slot;e instanceof HTMLTemplateElement?t=e.content:e instanceof HTMLElement?t=document.createRange().createContextualFragment(e.innerHTML):"string"==typeof e&&(t=document.createRange().createContextualFragment(e)),(s=t.querySelector(s))?(s.insertAdjacentHTML(this.position,r),this.output.shadowRoot||this.output.attachShadow({mode:"open"})):(console.warn(`Could not find ${s} in template`),this.output.insertAdjacentHTML(this.position,r)),"afterbegin"===this.position?this.output.shadowRoot.prepend(t):this.output.shadowRoot.append(t)}else this.output.insertAdjacentHTML(this.position,r)}getStyle(t){let e;switch(t){case"pass":e="color:limegreen; font-weight:bold";break;case"fail":e="color:red; font-weight:bold";break;case"info":e="color:darkorange; font-weight:bold";break;default:e="color:dodgerblue; font-weight:bold"}return e}printResult(t,e,s,n,i){const o=this.testNum?String(100+this.testNum).slice(-2):"";if(this.onlyFailed&&("pass"===e||"mock"===e||"info"===e))return;const r=this.getStyle(e);switch(t="string"==typeof t?t.replace(/[^\S\n\r]{2,}/g,""):JSON.stringify(t),e){case"fail":"console"===this.output?null===i?console.debug(`${this.testNum}: %c${e}`,r,t,{expected:n,result:s}):console.debug(`${this.testNum}: %c${e}`,r,t,{expected:n,result:s,line:i}):this.#l(t,e,s,n,i,o);break;case"pass":this.onlyFailed||"console"!==this.output?this.onlyFailed||this.#l(t,e,s,n,i,o):null===i?console.debug(`${this.testNum}: %c${e}`,r,t,{expected:n,result:s}):console.debug(`${this.testNum}: %c${e}`,r,t,{expected:n,result:s,line:i});break;case"mock":case"info":"console"===this.output?null===i?console.debug(`%c${e} | ${t}`,r):console.debug(`%c${e} | ${i} | ${t}`,r):this.#l(t,e,null,null,i,null);break;case"elapsed":"console"===this.output&&console.debug(`%c${e} | ${t}`,r);break;default:"console"===this.output?(i=null===i?"":`on line ${i}`,console.debug(`%c${e} ${s} ${i} | ${t}`,r)):this.#l(t,e,s,null,i,null)}}async run(){this.initialized||await this.init(),"console"===this.output?(console.debug(`ATestRunner starting: ${this.filePath}`),console.debug(`Total tests found: ${this.totalTests}`)):this.printResult(`Total tests: ${this.totalTests}`,"info",null,null,null);let t,e,s,n,i=!0,o=this.A;o.mod=null;for(const r of this.tests){n=o.mod;let l=r[0];const a=r[2];if(l.startsWith("mock")){l=l.replace("mock","").trim();try{const t=new Function("a, mod",`${l}`);e=await t(o,n)}catch(e){i=!1,t="Error parsing mock expression.",this.printResult(l,"error",`${t} ${e.message}`,"",a),console.error(`${t} on line: ${a}`,e)}this.printResult(l,"mock",null,null,a);continue}if(l.startsWith("info")){this.printResult(l.replace("info","").trim(),"info",null,null,a);continue}this.testNum++,n=o.mod;try{const t=/\breturn\b/.test(l)?l:`return ${l}`,s=new Function("a, mod",t);e=await s(o,n)}catch(e){i=!1,t="Error parsing test.",this.printResult(l,"error",`${t} ${e.message}`,null,a),console.error(`${t} on line: ${a}`,e);continue}try{const t=new Function("a",`return ${r[1]}`);s=await t(o)}catch(e){i=!1,t="Error parsing expected value.",this.printResult(l,"error",`${t} ${e.message}`,null,a),console.error(`${t} on line: ${a}`,e);continue}const u=this.#r(e,s,a);"fail"===u&&(i=!1),this.printResult(l,u,e,s,a),"fail"===u&&this.pauseOnFail&&this.printResult("","paused","Test runner has paused...","","")}const r=this.convertTime(Date.now()-this.startTime);return this.printResult(`${r.hours}:${r.minutes}:${r.seconds}:${r.milliseconds}`,"elapsed",null,null,null),i}get order(){return"afterbegin"===this.position?"desc":"asc"}set order(t){"desc"===t.toLowerCase()?(this.position="afterbegin",this.#t="desc"):(this.position="beforeend",this.#t="asc")}get output(){return this.#e}set output(t){t instanceof HTMLElement?this.#e=t:"console"===t.toLowerCase()?this.#e="console":(this.#e=document.body.querySelector(t),this.#e||(console.warn(`ATestRunner cannot find ${t} in the DOM. Defaulting to "console".`),this.#e="console"))}}class e{lineNumbers=null;onlyFailed=null;output=null;pauseOnFail=null;startTime=Date.now();template=null;passing=!0;async delay(t){return new Promise((e=>setTimeout(e,t)))}elapsed(){const t=this.testRunner.convertTime(Date.now()-this.startTime);this.passing&&console.debug("%cPassed","font-weight:bold; color:lime"),this.testRunner.printResult(`${t.hours}:${t.minutes}:${t.seconds}:${t.milliseconds}`,"elapsed",null,null,null)}equal(t,e){return t===e||null!=t&&null!=e&&"object"==typeof t&&"object"==typeof e&&Object.keys(t).length===Object.keys(e).length&&Object.keys(t).every((s=>t[s]===e[s]))}*genCombos(t){const e=Object.keys(t),s=Object.values(t);yield*function*t(n,i){if(n===e.length)return void(yield{...i});const o=e[n],r=s[n];if(Array.isArray(r))for(const e of r)i[o]=e,yield*t(n+1,i);else i[o]=r,yield*t(n+1,i)}(0,{})}info(t){if(this.onlyFailed)return;let e=null;if(this.lineNumbers)try{throw new Error("")}catch(t){const s=t.stack.split("\n");e=s[2].substring(s[2].lastIndexOf("/")+1,s[2].lastIndexOf(":"))}this.testRunner.printResult(t,"info",null,null,e)}_init(t){return this.testRunner=t,this}async test(t,e,s){this.testNum++;let n=null;const i=e===s?"pass":"fail";if(this.testRunner.lineNumbers)try{throw new Error("")}catch(t){const e=t.stack.split("\n");n=e[2].substring(e[2].lastIndexOf("/")+1,e[2].lastIndexOf(":"))}"fail"===i&&(this.passing=!1),"pass"===i&&this.onlyFailed||this.testRunner.printResult(t,i,e,s,n)}async when(t,{checkIntervalMs:e=500,timeoutMs:s=2e3}={}){const n=Date.now();for(;;){if(null!==s&&Date.now()-n>=s)throw new Error(`when() timed out after ${s}ms waiting for condition to be true`);if(!0===await t())return!0;await this.delay(e)}}async whenAllDefined(t=[],e=0){return new Promise(((s,n)=>{let i;Promise.all(t.map((t=>customElements.whenDefined(t)))).then((t=>{clearTimeout(i),s(t)})).catch((t=>{clearTimeout(i),n(t)})),i=setTimeout((()=>{n(new Error("Timed out waiting for custom elements"))}),e)}))}}class s extends HTMLElement{#a=!1;#u=!1;#c=!0;#h="";#d=!1;#t="asc";#p=!1;summary=HTMLElement;timeStart=Date.now();static observedAttributes=["all","console","elapsed","file","open","order","pause"];static template='\n    <style>\n      :host {\n        display: block;\n        --pass: lightgreen;\n        --fail: salmon;\n      }\n\n      div {\n        border-top: 1px solid gray;\n        display: grid;\n        column-gap: 1rem;\n        grid-template-columns: clamp(2ch, 3ch, 6ch) 4ch 2fr 2fr 1fr;\n        overflow-y: clip;\n        overflow-x: auto;\n        padding: 0 .25rem;\n      }\n\n      div.pass {\n        background-color: var(--pass);\n        color: black;\n      }\n\n      div.fail {\n        background-color: var(--fail);\n        color: black;\n      }\n\n      div.mock,\n      div.error) {\n        display: flex;\n        gap: 2rem;\n      }\n\n      div.error {\n        background: darkred;\n        color: white;\n      }\n\n      .test {\n        grid-column: auto / span 5;\n      }\n\n      summary { padding: .25rem; cursor:pointer }\n      summary.pass { background: limegreen; }\n      summary.pass::after { content: " Passing"; }\n      summary.fail { background: indianred; }\n      summary.fail::after { content: " Failing"; }\n    </style>\n    <details>\n      <summary> <slot name="title">Tests:</slot> </summary>\n      <section id="tests"></section>\n    </details>';constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.innerHTML=s.template}async connectedCallback(){this.summary=this.shadowRoot.querySelector("summary"),this.tester=new t(this.file),this.tester.output=this.shadowRoot.querySelector("#tests"),this.tester.onlyFailed=!this.all,this.tester.pauseOnFail=this.pause,this.tester.order=this.order,this.summary.textContent+=` ${this.file} | `,this.testFile(this.file)}attributeChangedCallback(t,e,s){this[t]=s}async testFile(t){const e=await this.tester.run();if(this.summary.className=e?"pass":"fail",this.elapsed){const t=this.tester.convertTime(Date.now()-this.timeStart);this.summary.textContent+=`${t.hours}:${t.minutes}:${t.seconds}:${t.milliseconds} |`}}get console(){return this.#u}set console(t){switch(t){case!1:case"false":this.#u=!1;break;default:this.#u=!0}}get elapsed(){return this.#c}set elapsed(t){switch(t){case"false":case!1:this.#c=!1;break;default:this.#c=!0}}get all(){return this.#a}set all(t){switch(t){case!1:case"false":this.#a=!1;break;default:this.#a=!0}}get file(){return this.#h}set file(t){t.startsWith(".")&&t.startsWith("/")||(t="/"+t),this.#h=t}get open(){return this.#d}set open(t){const e=this.shadowRoot.querySelector("details");switch(t){case"false":case!1:this.#d=!1,e.toggleAttribute("open",!1);break;default:this.#d=!0,e.toggleAttribute("open",!0)}}get order(){return this.#t}set order(t){"asc"!==t&&"desc"!==t||(this.#t=t)}get pause(){return this.#p}set pause(t){switch(t){case"false":case!1:this.#p=!1;break;default:this.#p=!0}}}document.addEventListener("DOMContentLoaded",(()=>{customElements.get("test-runner")||customElements.define("test-runner",s)}));export{s as TestRunnerComponent,t as default};
