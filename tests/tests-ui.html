<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Simple UI Tests</title>

  <script type="module" src="../src/a-bind.js"></script>

  <!-- <script type="module" src="t-runner.test.js"></script> -->

	<link rel="stylesheet" href="../extra/styles.css">

  <style>
    [disabled] {
      background: silver;
      color: gray;
      cursor: not-allowed;
    }
  </style>

  <script>
    class CustomElement extends HTMLElement {
      // Attributes
      #myInput = 'foo';
      #mySelect = 'foo';
      #mySelectmulti = ['foo', 'bar'];
      #myCheckbox = 'foo';
      #myRadiogroup = 'foo';
      #myButton = 'foo';
      #someAttr = 'attr value';

      // Public Properties
      isDisabled = true;
      propA = 'Value A';
      propB = 'Value B';
      myColor = 'red';
      options = 'foo, bar, baz';
      user = { name: 'Alice' };

      // Private Properties
      #myFileInput;
      #result;
      #resultHandleFiles;

      static observedAttributes = [
        'my-input',
        'my-select',
        'my-selectmulti',
        'my-checkbox',
        'my-radiogroup',
        'my-button',
        'some-attr'
      ];

      constructor() { super(); }

      attributeChangedCallback(attr, oldval, newval) {
        switch (attr) {
          case "my-input": this.#myInput = newval; break;
          case "my-select": this.#mySelect = newval; break;
          case "my-selectmulti":
            newval = newval.split(/[,\s]+/g);
            this.#mySelectmulti = newval;
            break;
          case "my-checkbox": this.#myCheckbox = newval; break
          case "my-radiogroup": this.#myRadiogroup = newval; break;
          case "my-button": this.#myButton = newval; break;
          case "some-attr": this.#someAttr = newval; break;
        }

        if (window.abind) abind.updateDefer(this, attr);
      }

      buildOptionList(optionStr) {
        return optionStr
        .split(',')
        .map(option => `<option>${option}</option>`)
        .join("\n");
      }

      handleFiles(event) {
        const files = event.target.files;
        const arr = [];
        this.#myFileInput = files;
        for (const file of files) {
          arr.push({
            name: file.name,
            type: file.type,
            size: file.size,
            modified: file.lastModified
          })
        };
        this.resultHandleFiles = `Files: ${JSON.stringify(arr, null, 2)}`
      }

      handleClick(event) {
        const value = event.target.value;
        const other = event.target.dataset.other;
        const msg = `
          Context (this): ${this.constructor.name}
          Function: handleClick ( event )
          Event passed: ${event}
          event.target: ${event.target}
          event.target.value: " ${value} "
          event.target.dataset.other: " ${other} "
        `;

        this.result = msg;
      }

      setOption(event) {
        const value = event.target.value;
        const property = event.target.dataset.property;
        this[property] = value;
      }

      /***************************************************
      * Attributes
      * abind update happens in attributeChangedCallback()
      ***************************************************/
      get myInput() { return this.#myInput }
      set myInput(value) { this.setAttribute('my-input', value) }

      get mySelect() { return this.#mySelect }
      set mySelect(value) { this.setAttribute('my-select', value) }

      get mySelectmulti() { return this.#mySelectmulti }
      set mySelectmulti(value) { this.setAttribute('my-selectmulti', value) }

      get myCheckbox() { return this.#myCheckbox }
      set myCheckbox(value) { this.setAttribute('my-checkbox', value) }

      get myRadiogroup() { return this.#myRadiogroup; }
      set myRadiogroup(value) { this.setAttribute('my-radiogroup', value)}

      get myButton() { return this.#myButton }
      set myButton(value) { this.setAttribute('my-button', value) }

      get someAttr() { return this.#someAttr }
      set someAttr(value) { this.setAttribute('some-attr', value) }

      /*****************************************
       * not attributes
       * abind updates happen in the setter
       ****************************************/
      get dynamicOptions() {
        return this.buildOptionList(this.options)
      }
      set dynamicOptions(value) {
        const options1 = 'foo, bar, baz';
        const options2 = 'one, two, three';
        this.options = (this.options === options1) ? options2 : options1;
        if (window.abind) abind.updateDefer(this, 'dynamicOptions');
      }

      get result() { return this.#result }
      set result(value) {
        this.#result = value;
        if (window.abind) abind.update(this, 'result', value);
      }

      get resultHandleFiles() { return this.#resultHandleFiles }
      set resultHandleFiles(value) {
        this.#resultHandleFiles = value;
        if (window.abind) abind.updateDefer(this, 'resultHandleFiles');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      customElements.define('custom-element', CustomElement);
    });
  </script>
</head>
<body>

<custom-element some-attr="attr value"></custom-element>

<h1>Integration Tests</h1>

<!--
  <div class="card">
    <p><small>

    </small></p>
    <div class="flex space-around">
      <a-bind
        model="custom-element"
        property="">
        input
      </a-bind>

      <div class="flex column">
        property
        <a-bind
          pull
          model="custom-element"
          property="">
          <output></output>
        </a-bind>
      </div>
    </div>
  </div>
-->


<section>
<h2>text-ish inputs</h2>

  <div class="card">
    <p>
      <small>
        input value is bound to property myInput
      </small>
    </p>

    <div class="flex space-around">
      <a-bind
        model="custom-element"
        property="myInput">
        <input id="my-input">
      </a-bind>

      <div class="flex column">
        myInput
        <a-bind
          pull
          model="custom-element"
          property="myInput">
          <output>...</output>
        </a-bind>
      </div>
    </div>
  </div>

  <div class="card">
    <p>
      <small>
        input value is bound to property myInput<br>
        input is disabled when `isDisabled` is true;
      </small>
    </p>

    <div class="flex space-around">
      <a-bind
        pull
        model="custom-element"
        property="isDisabled"
        elem-attr="disabled">
        <a-bind
          model="custom-element"
          property="myInput">
          <input id="my-input">
        </a-bind>
      </a-bind>

      <div class="flex column gap0">
        myInput
        <a-bind
          pull
          model="custom-element"
          property="myInput">
          <output>...</output>
        </a-bind>
        <hr>
        isDisabled
        <a-bind
          model="custom-element"
          property="isDisabled">
          <input type="checkbox" value="true">
        </a-bind>
      </div>
    </div>
  </div>
</section>

<section>
<h2>Select inputs</h2>

  <div class="card">
    <p>
      <small>
        Simple select<br>
        Initial selected option is "foo"
      </small>
    </p>

    <div class="flex space-around">
      <a-bind
        model="custom-element"
        property="mySelect">
        <select id="my-select">
          <option value="">Select...</option>
          <option>foo</option>
          <option>bar</option>
          <option>baz</option>
        </select>
      </a-bind>

      <div class="flex column">
        mySelect
        <a-bind
          pull
          model="custom-element"
          property="mySelect">
          <output></output>
        </a-bind>
      </div>
    </div>
  </div>

  <div class="card">
    <p><small>
      select multiple<br>
      Initial selected options are 'foo' and 'bar'
    </small></p>
    <div class="flex space-around">
      <a-bind
        model="custom-element"
        property="mySelectmulti"
        elem-attr="selectedOptions">
        <select multiple size="3" id="my-select-multi">
          <option>foo</option>
          <option>bar</option>
          <option>baz</option>
        </select>
      </a-bind>

      <div class="flex column">
        mySelectmulti
        <a-bind
          pull
          model="custom-element"
          property="mySelectmulti">
          <output></output>
        </a-bind>
      </div>
    </div>
  </div>

  <div class="card">
    <p><small>
      Dynamic Options
    </small></p>

    <div class="flex space-around">
      <div class="flex column">
        <a-bind
          model="custom-element"
          event="click"
          func="dynamicOptions">
          <button>Change Options</button>
        </a-bind>

        <a-bind
          pull
          model="custom-element"
          property="dynamicOptions"
          elem-attr="innerHTML">
          <a-bind
            push
            model="custom-element"
            property="mySelect">
            <select></select>
          </a-bind>
        </a-bind>
      </div>

      <div class="flex column">
        dynamicOptions
        <a-bind
          model="custom-element"
          property="dynamicOptions">
          <output></output>
        </a-bind>
      </div>

      <div class="flex column">
        mySelect
        <a-bind
          model="custom-element"
          property="mySelect">
          <output></output>
        </a-bind>
      </div>
    </div>
  </div>
</section>

<section>
<h2>Checkbox inputs</h2>

  <div class="card">
    <p><small>
      Checkbox is checked
    </small></p>
    <div class="flex space-around">
      <a-bind
        model="custom-element"
        property="myCheckbox">
        <input
          id="my-checkbox"
          type="checkbox"
          value="foo">
      </a-bind>

      <div class="flex column">
        myCheckbox
        <a-bind
          pull
          model="custom-element"
          property="myCheckbox">
          <output></output>
        </a-bind>
      </div>
    </div>
  </div>
</section>

<section>
<h2>Radio Group</h2>

  <div class="card">
    <p><small>
      simple radio inputs
    </small></p>
    <div class="flex space-around">
      <div class="flex column start flex1">
      <div class="flex start">
        <a-bind
          model="custom-element"
          property="myRadiogroup">
          <input
            id="rad-foo"
            type="radio"
            name="rad-group"
            value="foo">
        </a-bind>
        <label for="rad-foo"> value is "foo" : checked</label>
      </div>

      <div class="flex start">
        <a-bind
            model="custom-element"
            property="myRadiogroup">
            <input
              id="rad-bar"
              type="radio"
              name="rad-group"
              value="bar">
        </a-bind>
        <label for="rad-bar">value is "bar"</label>
      </div>
    </div>

      <div class="flex column">
        myRadiogroup
        <a-bind
          pull
          model="custom-element"
          property="myRadiogroup">
          <output></output>
        </a-bind>
      </div>
    </div>
  </div>
</section>

<section>
<h2>Buttons</h2>

  <div class="card">
    <p>
      <small>
        Invokes console.log(event) on click.
      </small>
    </p>

    <div class="flex gap2">
      <a-bind
        model="custom-element"
        event="click"
        func="console.log">
        <button
          id="button1"
          value="button.value"
          data-other="other value">
          Click Me!
        </button>
      </a-bind>

      <label for="button1">
        <small>func = "console.log"</small>
      </label>
    </div>
  </div>

  <div class="card">
    <p>
      <small>
        Changes the value of attribute <code>some-attr</code> on click.
      </small>
    </p>

    <div class="flex gap2 space-around">
      <a-bind
        push
        model="custom-element"
        model-attr="some-attr"
        event="click">
        <button id="button2" value="updated by button">
          Change the Attribute
        </button>
      </a-bind>

      <label for="button2">
        <small>
          push<br>
          model-attr="some-attr"<br>
          event="click"
        </small>
      </label>

      <a-bind
        pull
        model="custom-element"
        model-attr="some-attr"
        id="pull-test">
        <output>...</output>
      </a-bind>
    </div>
  </div>

  <div class="card">
    <p>
      <small>
        Button text mirrors property value.<br>
        Property value is updated from the button.value.<br>
        myButton === "foo"
    </small></p>

    <div class="flex gap2">
      <a-bind
        model="custom-element"
        property="myButton"
        elem-attr="textContent"
        event="click">

        <button
          id="button3"
          value="new value"
          data-other="other value">
          ...
        </button>
      </a-bind>

      <label for="button3">
        <small>
          property = "myButton"<br>
          elem-attr = "textContent"<br>
          event = "click"
        </small>
      </label>
    </div>
  </div>

  <div class="card">
    <p>
      <small>
        Button text mirrors property value.<br>
        Button value also mirrors property value.<br>
        Invokes handleClick(event) on click.<br>
        myButton === <a-bind model="custom-element" property="myButton" elem-attr="textContent">"<span></span>"</a-bind>
      </small>
    </p>

    <div class="flex gap2">
      <a-bind
        model="custom-element"
        property="myButton"
        elem-attr="textContent, value"
        event="click"
        func="handleClick">

        <button
          id="button4"
          value="button.value"
          data-other="other value">
          ...
        </button>
      </a-bind>

      <label for="button4"><small>
        property="myButton"<br>
        elem-attr = "textContent, value"<br>
        event = "click"<br>
        func = "handleClick"
      </small></label>

      <a-bind
        pull
        model="custom-element"
        property="result">
        <output></output>
      </a-bind>
    </div>
  </div>

  <div class="card">
    <p>
      <small>
        Button text does NOT mirror property value.<br>
        Button value DOES mirror property value.<br>
        Invokes handleClick(event) on click.<br>
        myButton === <a-bind model="custom-element" property="myButton" elem-attr="textContent">"<span></span>"</a-bind>
      </small>
    </p>

    <div class="flex gap2">
      <a-bind
        model="custom-element"
        property="myButton"
        event="click"
        func="handleClick">
        <button
          id="button5"
          value="button.value"
          data-other="other value">
          Click Me!
        </button>
      </a-bind>

      <label for="button5"><small>
        property = "myButton"<br>
        event="click"<br>
        func = "handleClick"
      </small></label>

      <a-bind
        pull
        model="custom-element"
        property="result">
        Result: <output>...</output>
      </a-bind>
    </div>
  </div>

  <div class="card">
    <p>
      <small>
        Button is NOT bound to any property.<br>
        Invokes handleClick(event) on click.
      </small>
    </p>

    <div class="flex gap2">
      <a-bind
        model="custom-element"
        event="click"
        func="handleClick">
        <button
          id="button6"
          value="button.value"
          data-other="other value">
          Click Me!
        </button>
      </a-bind>

      <label for="button6">
        <small>func = "handleClick"</small>
      </label>

      <a-bind
        pull
        model="custom-element"
        property="result">
        <output>...</output>
      </a-bind>
    </div>
  </div>
</section>

<section>
<h2>File input</h2>

  <div class="flex">
    <a-bind
      model="custom-element"
      func="handleFiles">
      <input type="file" multiple id="file-input">
    </a-bind>

    <label for="my-button3">
      <small> func = "handleFiles" </small>
    </label>

    <a-bind
      pull
      model="custom-element"
      property="resultHandleFiles">
      <output></output>
    </a-bind>
  </div>
</section>

<section>
<h2>Other Tests</h2>
  <div class="card">
    <p><small>
      For testing the `once` attribute
    </small></p>

    <div class="flex space-around">
      <a-bind
        once
        model="custom-element"
        property="myInput">
        <output id="once-output">...</output>
      </a-bind>

      <a-bind
        push
        model="custom-element"
        property="myInput"
        event="click">
        <button
          id="button7"
          value="new value">
            Attempt to change the value
          </button>
      </a-bind>
    </div>
  </div>

  <div class="card">
    <p><small>
      For testing `style.*` binding
    </small></p>

      <a-bind
        pull
        model="custom-element"
        property="myColor"
        elem-attr="style.color">
        <div id="style-binding-div">This text should be red.</div>
      </a-bind>
    </div>
  </div>

  <div class="card">
    <p><small>
      Testing nested property binding (ie. user.name)
    </small></p>

    <div class="flex space-around">
      <a-bind
        model="custom-element"
        property="user.name">
        <input id="nested-prop-input">
      </a-bind>
    </div>
  </div>
</section>
</body>
</html>
