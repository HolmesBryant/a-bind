class t extends HTMLElement{#t="value";#e="input";#s=null;#o;#i=null;#r=!1;#n=!1;#l;#d;#h;#a=!1;#c=!1;#u;static observedAttributes=["model","property","model-attr","event","elem-attr","func","one-way","once"];constructor(){super(),window.abind||(window.abind=t)}attributeChangedCallback(t,e,s){if(e===s)return;switch(t){case"model":this.#o=s;break;case"property":this.#l=s;break;case"model-attr":this.#i=s;break;case"event":this.#e=s;break;case"elem-attr":this.#t=s;break;case"func":this.#s=s;break;case"one-way":this.#n="false"!==s&&!1!==s;break;case"once":this.#r="false"!==s&&!1!==s}["model","property","model-attr"].includes(t)&&this.#c&&(this._teardown(),this._initialize())}connectedCallback(){this._initialize(),this.#c=!0}disconnectedCallback(){this._teardown()}static update(t,e,s){"inline"===e&&console.trace(s);const o=new CustomEvent("abind:update",{detail:{model:t,property:e,value:s}});document.dispatchEvent(o)}formatForJson(t){let e;const s=/^(\p{L}+)$/u,o=/["'](\p{L}+)["']/gu,i=/(?<=[\s,{:])(?:true|false|null|undefined|-?\d+(?:\.\d+)?|[\p{L}\p{N}_$]+)(?=[\s,}:])/gu;return e=(t=t.trim()).match(s),e?t.replace(s,'"$1"'):(e=t.match(i),e?t.replaceAll(i,'"$&"'):(e=t.match(o),e?t.replace(o,'"$1"'):(e=t.match(/(?<=[\s,\[])(?:true|false|null|undefined|-?\d+(?:\.\d+)?|\p{L}+)(?=[\s,\]])/gu),e?JSON.stringify(e):t)))}_executeFunction(t){let e,s=this.#l;const o=t.split(";");let i=o.shift();o.length>0&&(e=o.pop().split(",").map((t=>t.trim())),o[0]&&(s=o[0].trim())),e||(e=[this.#h[this.elemAttr]]),i.includes(".")?this._executeFunctionPath(i,contextPath,s,e):this._executeFunctionProp(i,s,e)}_executeFunctionPath(t,e,s){let o,i;const r=t.substring(0,t.lastIndexOf(".")),n=t.split(".").pop();o=this._getObjectProperty(this.#u,r),i=o?o[n]:void 0,"function"!=typeof i&&(o=this._getObjectProperty(window,r),i=o?o[n]:void 0),"function"==typeof i&&i.call(o,e,s)}_executeFunctionProp(t,e,s){let o,i;o=this.#u,"function"==typeof this.#u[t]?i=this.#u[t]:void 0!==this.#u[t]?o[t]=s:"function"==typeof window[t]&&(i=window[t],o=window),"function"==typeof i&&i.call(o,e,s)}async _getModel(t,e=.5){return new Promise((s=>{const o=setTimeout((()=>{console.error(`Timeout: ${t} not found.`),s(null)}),1e3*e),i=t=>{clearTimeout(o),s(t)};if(window[t])i(window[t]);else{const[e,...s]=t.split("#"),o=s.length?`${e}#${s.join("#")}`:e;customElements.whenDefined(e).then((()=>i(document.querySelector(o)))).catch((()=>{console.error(`${t} is not a valid JavaScript object or custom element.`),i(null)}))}}))}_getObjectProperty(t,e){return e?e.split(".").reduce(((t,e)=>t&&t[e]),t):t}_handleElementEvent(t){let e;if(t.preventDefault(),this.#n||this.#s)return this.#s?this._executeFunction(this.#s):void 0;const{localName:s,type:o,checked:i,selectedOptions:r}=this.#h;e="select"===s&&this.#h.hasAttribute("multiple")?Array.from(r).map((t=>t.value)):"checkbox"===o?i?this.#h.value:"":this.#h[this.#t],this._updateModel(e)}_handleModelUpdate(t){if(this.#u===t.detail.model&&this.#l===t.detail.property){if(this.#i&&this.#u instanceof HTMLElement){const t=this.#u.constructor.observedAttributes;if(!t||!t.includes(this.#i))return}this.#r&&this.#a||(this.#i?this.#h[this.#t]=this.#u.getAttribute(this.#i):this._updateElement(t.detail.value),this.#a=!0)}}async _initialize(){return this.#o=this.getAttribute("model"),this.#o?(this.#h=this.children[0],this.#h?(this.#u=await this._getModel(this.#o),this.#u?(this.#i&&(/[\p{Lu}]/u.test(this.#i)&&console.warn(`a-bind: The 'model-attr' value "${this.#i}" contains uppercase characters. HTML attributes are typically lower-kebab-case.`,this),this.#l||(this.#l=this.#i.replace(/-(.)/g,((t,e)=>e.toUpperCase())))),this.#d=new AbortController,this._setupListeners(),void this._updateElement()):console.error(`The model "${this.#o}" could not be found.`)):console.error("a-bind element must have one child which is an HTML element",this)):console.error('a-bind requires a model to bind to: model="..."',this)}_setElementAttribute(t,e,s){s&&"undefined"!==s||(s="");const{localName:o,type:i}=t;if(e.startsWith("style."))t.style[e.split(".")[1]]=s;else switch(o){case"input":"checkbox"===i||"radio"===i?t.checked=t.value===String(s):"file"!==i&&(t[e]=s);break;case"select":if(t.hasAttribute("multiple")){const e=Array.isArray(s)?s:String(s).split(/[,\s]+/);for(const s of t.options)s.selected=e.includes(s.value)}else t[e]=s;break;default:t[e]=s}}_setupListeners(){(this.#l||this.#s)&&this.#h&&(this.#h.addEventListener(this.#e,this._handleElementEvent.bind(this),{signal:this.#d.signal}),this.#l&&document.addEventListener("abind:update",this._handleModelUpdate.bind(this),{signal:this.#d.signal}))}_setObjectProperty(t,e,s){const o=e.split("."),i=o.pop(),r=o.length?this._getObjectProperty(t,o.join(".")):t;r&&"object"==typeof r&&(r[i]=s)}_teardown(){this.#d&&(this.#d.abort(),this.#d=null),this.#h=null,this.#u=null}_updateElement(t){if(!this.#l&&!this.#i)return;if(this.#n&&this.#a)return;void 0===t&&(t=this.#i?this.#u.getAttribute(this.#i)??"":this.#l.startsWith("--")&&this.#u instanceof HTMLElement?getComputedStyle(this.#u).getPropertyValue(this.#l):this._getObjectProperty(this.#u,this.#l));const e=this.#t.split(/[,\s]+/);for(const s of e)this._setElementAttribute(this.#h,s.trim(),t);this.#a=!0}_updateModel(e){if(this.#l){this._getObjectProperty(this.#u,this.#l)!==e&&(this.#i?this.#u.setAttribute(this.#i,e):this.#l.startsWith("--")?this.#u.style.setProperty(this.#l,e):this._setObjectProperty(this.#u,this.#l,e),t.update(this.#u,this.#l,e))}this.#s&&this._executeFunction(e)}get elemAttr(){return this.#t}set elemAttr(t){this.setAttribute("elem-attr",t)}get event(){return this.#e}set event(t){this.setAttribute("event",t)}get func(){return this.#s}set func(t){this.setAttribute("func",t)}get model(){return this.#o}set model(t){this.setAttribute("model",t)}get modelAttr(){return this.#i}set modelAttr(t){this.setAttribute("model-attr",t)}get once(){return this.#r}set once(t){this.setAttribute("once",String(t))}get oneWay(){return this.#n}set oneWay(t){this.setAttribute("one-way",String(t))}get property(){return this.#l}set property(t){this.setAttribute("property",t)}}document.addEventListener("DOMContentLoaded",(()=>{customElements.get("a-bind")||customElements.define("a-bind",t)}));export{t as default};
