/**
 * @author Holmes Bryant <https://github.com/HolmesBryant>
 * @license GPL-3.0
 */
class t extends HTMLElement{#t;#e;#o=!1;#s=!1;#i;static observedAttributes=["model","property","model-attr","event","elem-attr","func","pull","push","once","debug"];constructor(){super(),window.abind||(window.abind=t)}attributeChangedCallback(t,e,o){e!==o&&["model","property","model-attr"].includes(t)&&this.#s&&(this.#l(),this.#r())}connectedCallback(){this.debug&&console.debug("Debugging:",this),this.#s=!0,this.#r()}disconnectedCallback(){this.#s=!1,this.#l()}static update(t,e,o){const s=new CustomEvent("abind:update",{detail:{model:t,property:e,value:o}});document.dispatchEvent(s)}#n(t){const e=this.func;if(this.debug&&console.debug("#executeFunction",{funcPath:e,Bail:!e}),!e)return;let o=null,s=null;const i=e.split("."),l=i.pop(),r=i.join(".");let n=this.#d(this.#i,r);if(n&&"function"==typeof n[l]?(o=n,s=n[l]):n&&n[l]?(o=n,s=l):(n=this.#d(window,r),n&&"function"==typeof n[l]&&(o=n,s=n[l])),"function"==typeof s)s.call(o,t);else if("string"==typeof s){const e=Object.getPrototypeOf(this.#i);Object.getOwnPropertyDescriptor(e,s).set.call(o,t)}else console.warn(`a-bind: Function "${e}" not found on model or window.`,this);this.debug&&console.debug("#executeFunction",{event:t,context:o,func:s})}async#u(t,e=.5){return new Promise((o=>{const s=setTimeout((()=>{console.error(`Timeout: ${t} not found.`),o(null)}),1e3*e),i=t=>{clearTimeout(s),o(t)};if(window[t])i(window[t]);else{const e=document.querySelector(t);t=e.localName,customElements.whenDefined(t).then((()=>i(e))).catch((()=>i(null)))}}))}#d(t,e){return e?e.split(".").reduce(((t,e)=>t&&t[e]),t):t}#h(t){if(this.func&&this.#n(t),this.pull||!this.property&&!this.modelAttr)return;let e;const{localName:o,type:s,checked:i,selectedOptions:l}=this.#e;e="select"===o&&this.#e.multiple?Array.from(l).map((t=>t.value)):"checkbox"===s?!!i&&this.#e.value:t.target.value?t.target.value:this.#e[this.elemAttr],this.debug&&console.debug("#handleElementEvent",{event:t,value:e}),this.#a(e)}#c(t){const e=this.property&&this.property===t.detail.property,o=this.modelAttr?this.modelAttr.replace(/-(.)/g,((t,e)=>e.toUpperCase())):null,s=this.modelAttr&&o===t.detail.property,i=()=>this.once&&this.#o||this.#i!==t.detail.model||!(e||s);this.debug&&console.debug("#handleModelUpdate",{event:t,event_detail:t.detail,isBoundToProperty:e,isBoundToAttr:s,once:this.once,hasUpdated:this.#o,Bail:i()}),i()||this.#p(t.detail.value)}async#r(){const t=this.model;if(!t)return console.error('a-bind: "model" attribute is required.',this);let e=this.children[0];for(;e&&"a-bind"===e.localName;)e=e.children[0];if(this.#e=e,!this.#e)throw console.error("a-bind: Must have one child element.",this),new Error("a-bind: Must have one child element.");if(this.#i=await this.#u(t),!this.#i)return console.error(`a-bind: Model "${t}" not found.`,this);this.#t=new AbortController,this.debug&&console.debug("#initialize",{boundElement:this.#e,model:this.#i}),this.#b(),this.#p()}#m(t,e,o){const s=e.split("."),i=s.pop(),l=s.length?this.#d(t,s.join(".")):t;l&&"object"==typeof l&&(l[i]=o),this.debug&&console.debug("#setObjectProperty",{obj:t,path:e,value:o,target:l,lastPart:i})}#g(t,e,o){null==o&&(o="");const{localName:s,type:i}=t;if(this.debug&&console.debug("#setElementAttribute",{element:t,attribute:e,value:o}),e.startsWith("style."))t.style[e.split(".")[1]]=o;else switch(s){case"input":"checkbox"===i||"radio"===i?t.checked=t.value===String(o):"file"!==i&&(t[e]=o);break;case"select":if(t.multiple){const e=Array.isArray(o)?o.map(String):String(o).split(/[,\s]+/);for(const o of t.options)o.selected=e.includes(o.value)}else t[e]=o;break;default:t[e]=o}}#b(){if(!this.property&&!this.func&&!this.modelAttr)return;const{signal:t}=this.#t;this.#e.addEventListener(this.event,(t=>this.#h(t)),{signal:t}),(this.property||this.modelAttr)&&document.addEventListener("abind:update",(t=>this.#c(t)),{signal:t})}#l(){this.#t?.abort(),this.#t=null,this.#e=null,this.#i=null}#p(t){const e=()=>!this.property&&!this.modelAttr||this.once&&this.#o||this.push;this.debug&&console.debug("#updateElement",{property:this.property,modelAttr:this.modelAttr,once:this.once,hasUpdated:this.#o,push:this.push,Bail:e()}),e()||(void 0===t&&(t=this.modelAttr?this.#i.getAttribute(this.modelAttr)??"":this.#d(this.#i,this.property)),this.debug&&console.debug("#updateElement",{value:t}),this.elemAttr.split(/[,\s]+/).forEach((e=>{this.#g(this.#e,e.trim(),t)})),this.#o=!0)}#a(e){let o;o=this.modelAttr?this.#i.getAttribute(this.modelAttr):this.#d(this.#i,this.property);const s=()=>String(o)===String(e);if(this.debug&&console.debug("#updateModel",{value:e,oldValue:o,Bail:s()}),s())return;this.modelAttr?this.#i.setAttribute(this.modelAttr,e):this.#m(this.#i,this.property,e);const i=this.property||this.modelAttr.replace(/-(.)/g,((t,e)=>e.toUpperCase()));t.update(this.#i,i,e)}get elemAttr(){return this.getAttribute("elem-attr")||"value"}set elemAttr(t){this.setAttribute("elem-attr",t)}get event(){return this.getAttribute("event")||"input"}set event(t){this.setAttribute("event",t)}get func(){return this.getAttribute("func")}set func(t){this.setAttribute("func",t)}get model(){return this.getAttribute("model")}set model(t){this.setAttribute("model",t)}get modelAttr(){return this.getAttribute("model-attr")}set modelAttr(t){this.setAttribute("model-attr",t)}get once(){return this.hasAttribute("once")}set once(t){this.toggleAttribute("once",Boolean(t))}get pull(){return this.hasAttribute("pull")}set pull(t){this.toggleAttribute("pull",Boolean(t))}get push(){return this.hasAttribute("push")}set push(t){this.toggleAttribute("push",Boolean(t))}get property(){return this.getAttribute("property")}set property(t){this.setAttribute("property",t)}get debug(){return this.hasAttribute("debug")}set debug(t){this.toggleAttribute("debug",Boolean(t))}}customElements.get("a-bind")||customElements.define("a-bind",t);export{t as default};
