/**
 * @author Holmes Bryant <https://github.com/HolmesBryant>
 * @version 2.5.0
 * @license GPL-3.0
 */
const t={getSignature(t){if(!t)return"null";if(3===t.nodeType)return"#text";let e=t.localName;return t.id&&(e+=`#${t.id}`),t.classList?.length&&(e+=`.${[...t.classList].join(".")}`),e},log(e,i,s={}){if(!e.debug)return;const n="group"===e.type?"#5e35b1":"#00796b",o=e.signature||"unknown";console.groupCollapsed(`%c ${e.tagName} %c ${o} %c ${i} `,`background: ${n}; color: white; border-radius: 3px 0 0 3px; padding: 2px 5px; font-weight: bold;`,"background: #444; color: white; padding: 2px 5px;","background: transparent; color: unset; font-weight: bold; padding-left: 5px;"),s.reason&&console.log(`%cReason: ${s.reason}`,"font-weight:bold; color: #d81b60");try{const e=JSON.parse(JSON.stringify(s,((e,i)=>i instanceof HTMLElement?t.getSignature(i):i)));console.table(e)}catch(t){console.log(s)}s.raw&&console.dir(s.raw),console.groupEnd()}},e=new WeakMap,i={updates:new Map,requested:!1,add(t,e,i){this.updates.set(t,{value:e,reason:i}),this.requested||(this.requested=!0,requestAnimationFrame((()=>this.flush())))},flush(){this.updates.forEach(((t,e)=>{e.isConnected&&e.applyUpdate(t.value,t.reason)})),this.updates.clear(),this.requested=!1}},s={registry:new Map,refCounts:new Map,pending:new Map,isModulePath:t=>/^(\.\/|\/|\.\.\/).*\.m?js$/.test(t),async resolve(t){if(!t)return null;if("object"==typeof t)return t;if(this.registry.has(t))return this.registry.get(t);if(this.pending.has(t))return this.pending.get(t);const e=(async()=>{let e=null;if(this.isModulePath(t))try{const i=await import(t),s=i.default||i[Object.keys(i)[0]];e=this.instantiate(s)}catch(e){return console.error(`a-bind: Import failed for ${t}`,e),null}else{try{const i=document.getElementById(t)||document.querySelector(t);i&&(e=i)}catch(t){}!e&&t in window&&(e=this.instantiate(window[t]))}return e?.localName?.includes("-")&&await customElements.whenDefined(e.localName),e})();this.pending.set(t,e);try{const i=await e;return i&&(this.registry.set(t,i),this.refCounts.has(t)||this.refCounts.set(t,0)),i}finally{this.pending.delete(t)}},incrementRef(t){if(t&&"string"==typeof t){const e=this.refCounts.get(t)||0;this.refCounts.set(t,e+1)}},decrementRef(t){if(t&&"string"==typeof t){const e=this.refCounts.get(t);void 0!==e&&(e<=1?(this.refCounts.delete(t),this.registry.delete(t)):this.refCounts.set(t,e-1))}},instantiate(t){try{return"function"==typeof t&&t.prototype?new t:t}catch{return t}}};class ModelObserver{#t=new Map;subscribe(t,e){this.#t.has(t)||this.#t.set(t,new Set),this.#t.get(t).add(e)}unsubscribe(t,e){if(this.#t.has(t)){const i=this.#t.get(t);i.delete(e),0===i.size&&this.#t.delete(t)}}publish(t,e){this.#t.has(t)&&this.#t.get(t).forEach((t=>t(e)))}}class ABind extends HTMLElement{#e={debug:!1,elemAttr:"value",event:"input",func:null,model:null,modelAttr:null,once:!1,property:null,pull:!1,push:!1,throttle:0};#i;#s;#n=!1;#o=null;#r=null;#l=!1;#c=!1;#d=null;#a=null;#h=null;static observedAttributes=["debug","elem-attr","event","func","model","model-attr","once","property","pull","push","throttle"];constructor(){super()}get#u(){return{debug:this.#e.debug,type:"bind",tagName:"a-bind",signature:`${t.getSignature(this)} â†’ ${t.getSignature(this.#s)}`}}attributeChangedCallback(t,e,i){if(e===i)return;const s=null!==i;switch(t){case"debug":this.#e.debug=s&&"false"!==i;break;case"model":this.#e.model=i;break;case"property":this.#e.property=i;break;case"model-attr":this.#e.modelAttr=i;break;case"event":this.#e.event=i;break;case"elem-attr":this.#e.elemAttr=i||"value";break;case"func":this.#e.func=i;break;case"throttle":this.#e.throttle=parseInt(i)||0;break;case"pull":this.#e.pull=s&&"false"!==i;break;case"push":this.#e.push=s&&"false"!==i;break;case"once":this.#e.once=s&&"false"!==i}this.#l&&["model","property","model-attr"].includes(t)&&this.#g()}connectedCallback(){window.abind||(window.abind=ABind),this.#l=!0,this.firstElementChild?this.#p("Connected"):(this.#a=new MutationObserver((()=>{this.firstElementChild&&(this.#a.disconnect(),this.#a=null,this.#p("Child Inserted"))})),this.#a.observe(this,{childList:!0}))}disconnectedCallback(){this.#f(),this.#o&&(s.decrementRef(this.#o),this.#o=null),this.#a&&(this.#a.disconnect(),this.#a=null),this.#l=!1;const t=this.closest("a-bindgroup");t&&t.unregister(this)}async#p(e){if(!this.#c){this.#c=!0;try{let i=this.firstElementChild;for(;i&&"a-bind"===i.localName;)i=i.firstElementChild;if(this.#s=i,!this.#s)return void(this.#e.debug&&console.warn("a-bind: No element to bind"));let n="None";const o=this.closest("a-bindgroup");if(o)if(o.register(this),this.#r)n="Manual/Existing";else{if(!o.model)return void t.log(this.#u,"Waiting for Group",{group:t.getSignature(o)});this.#r=o.model,n="Group (Immediate)"}else!this.#r&&this.#e.model&&(this.#r=await s.resolve(this.#e.model),n=`Loader (${this.#e.model})`,this.#r&&"string"==typeof this.#e.model&&(this.#o=this.#e.model,s.incrementRef(this.#o)));if(!this.#l)return;if(t.log(this.#u,"Initialized",{trigger:e,source:n,boundElement:t.getSignature(this.#s),raw:{model:this.#r}}),!this.#r)return;this.#i=new AbortController,this.#m(),this.#e.push||this.applyUpdate(void 0,"Initial Sync")}catch(t){console.error("a-bind error:",t)}finally{this.#c=!1}}}#g(){this.#f(),this.#p("Re-init")}#f(){this.#i?.abort(),this.#h&&clearTimeout(this.#h),this.#h=null;const t=ABind.#b(this.#r,!1),e=this.#e.property||this.#e.modelAttr;t&&e&&this.#d&&t.unsubscribe(e,this.#d),this.#d=null}#m(){if(!this.#e.property&&!this.#e.func&&!this.#e.modelAttr)return;if(this.#e.event&&!this.#e.pull&&this.#s.addEventListener(this.#e.event,(t=>this.#y(t)),{signal:this.#i.signal}),this.#e.push)return;const t=ABind.#b(this.#r,!0),e=this.#e.property||this.#e.modelAttr;t&&e&&(this.#d=t=>{this.#e.once&&this.#n||i.add(this,t,`Model Change (${e})`)},t.subscribe(e,this.#d))}applyUpdate(e,i){if(!this.#e.property&&!this.#e.modelAttr||this.#e.once&&this.#n||this.#e.push)return;let s=!1;if(void 0===e)if(s=!0,this.#e.modelAttr)if(this.#e.modelAttr.startsWith("style.")){const t=this.#e.modelAttr.substring(6);e=this.#r.style?this.#r.style[t]:void 0}else e=this.#r.getAttribute?this.#r.getAttribute(this.#e.modelAttr):void 0;else e=this.#v(this.#r,this.#e.property);t.log(this.#u,"Update DOM",{reason:i,value:e,fetched:s,target:this.#e.elemAttr});this.#e.elemAttr.split(",").map((t=>t.trim())).forEach((t=>this.#A(this.#s,t,e))),this.#n=!0}#y(e){if(this.#e.func)return void this.#C(e);if(this.#e.pull||!this.#e.property&&!this.#e.modelAttr)return;let i;const s=this.#s;i="select"===s.localName&&s.multiple?Array.from(s.selectedOptions).map((t=>t.value)):"checkbox"===s.type?!!s.checked&&(s.getAttribute("value")||!0):void 0!==e.target.value?e.target.value:s[this.#e.elemAttr]??s.value,t.log(this.#u,"DOM Event",{type:e.type,value:i}),this.#e.throttle>0?(this.#h&&clearTimeout(this.#h),this.#h=setTimeout((()=>{this.#w(i),this.#h=null}),this.#e.throttle)):this.#w(i)}#w(e){let i;if(this.#e.modelAttr)if(this.#e.modelAttr.startsWith("style.")){const t=this.#e.modelAttr.substring(6);i=this.#r.style?.[t]}else i=this.#r.getAttribute?.(this.#e.modelAttr);else i=this.#v(this.#r,this.#e.property);if(i==e)return;t.log(this.#u,"Update Model",{value:e,target:this.#e.property||this.#e.modelAttr}),this.#e.modelAttr?this.#e.modelAttr.startsWith("style.")?this.#r.style.setProperty(this.#e.modelAttr.substring(6),e):this.#r.setAttribute(this.#e.modelAttr,e):this.#I(this.#r,this.#e.property,e);const s=ABind.#b(this.#r,!1),n=this.#e.property||this.#e.modelAttr;s&&n&&s.publish(n,e)}#C(e){const i=this.#e.func.split("."),s=i.pop(),n=i.join(".");let o=n?this.#v(this.#r,n):this.#r;o&&"function"==typeof o[s]||(o=n?this.#v(window,n):window),t.log(this.#u,"Exec Func",{func:this.#e.func,found:!!o}),o&&"function"==typeof o[s]?o[s].call(o,e):console.warn(`Function ${this.#e.func} not found.`)}#v(t,e){if(!e)return t;const i=e.split(".");return i.some((t=>"__proto__"===t||"constructor"===t||"prototype"===t))?void 0:i.reduce(((t,e)=>t&&t[e]),t)}#I(t,e,i){const s=e.split(".");if(s.some((t=>"__proto__"===t||"constructor"===t||"prototype"===t)))return;const n=s.pop(),o=s.length?this.#v(t,s.join(".")):t;o&&"object"==typeof o&&(o[n]=i)}#A(t,e,i){if(null==i&&(i=""),e.startsWith("style.")){const s=e.substring(6);return void(s.startsWith("--")?t.style.setProperty(s,i):t.style[s]=i)}if("select"===t.localName&&t.multiple&&("value"===e||"selected"===e)){const e=(Array.isArray(i)?i:String(i).includes(",")?String(i).split(","):[i]).map((t=>String(t).trim()));for(const i of t.options)i.selected=e.includes(i.value);return}if("input"===t.localName&&("checkbox"===t.type||"radio"===t.type)&&("checked"===e||"value"===e&&"boolean"==typeof i))return void(t.checked=String(t.value)===String(i)||!0===i);const s=e,n=s in t,o=["list","form","type","width","height"].includes(s);if(n&&!o)try{t[s]=i,!1===i&&null!==t.getAttribute(s)&&t.removeAttribute(s)}catch(e){t.setAttribute(s,i)}else!1===i||null===i?t.removeAttribute(e):t.setAttribute(e,i)}static#b(t,i){return t&&"object"==typeof t?(!e.has(t)&&i&&e.set(t,new ModelObserver),e.get(t)||null):null}static update(t,e,i){const s=ABind.#b(t,!0);s&&s.publish(e,i)}static updateDefer(t,e,i=0){setTimeout((()=>{const i=e.split(".").reduce(((t,e)=>t&&t[e]),t);ABind.update(t,e,i)}),i)}get model(){return this.#r}set model(t){this.#r=t,this.#g()}}class ABindgroup extends HTMLElement{#E=!1;#k;#o=null;#r=null;#O=new Set;static observedAttributes=["debug","model"];constructor(){super()}get#u(){return{debug:this.#E,type:"group",tagName:"a-bindgroup",signature:t.getSignature(this)}}attributeChangedCallback(t,e,i){e!==i&&("debug"===t&&(this.#E="false"!==i),"model"===t&&(this.#k=i,this.isConnected&&this.#x()))}async connectedCallback(){this.#k&&await this.#x()}disconnectedCallback(){this.#o&&s.decrementRef(this.#o)}async#x(){const e=this.#k;if(e){t.log(this.#u,"Loading Model",{key:e});try{const i=await s.resolve(e);if(!i)throw new Error(`Could not resolve model: ${e}`);this.#r=i,this.#o=e,"string"==typeof e&&s.incrementRef(e),this.#M(),t.log(this.#u,"Model Loaded",{childCount:this.#O.size})}catch(t){console.error("a-bindgroup:",t)}}}register(t){this.#O.add(t),this.#r&&!t.model&&(t.model=this.#r)}unregister(t){this.#O.delete(t)}#M(){if(this.#r)for(const t of this.#O)t.model=this.#r}get debug(){return this.#E}set debug(t){this.toggleAttribute("debug",!1!==t)}get model(){return this.#r}set model(t){this.#r=t,this.#M()}}customElements.get("a-bind")||customElements.define("a-bind",ABind),customElements.get("a-bindgroup")||customElements.define("a-bindgroup",ABindgroup);export{ABindgroup,ABind as default};
